generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String              @id @default(cuid())
  username                String              @unique
  email                   String              @unique
  password                String
  firstName               String?
  lastName                String?
  gender                  String?
  phoneNumber             String?
  profilePicture          String?
  nationalIdNumber        String?             @unique
  nationalIdPhotoUrl      String?             @unique
  nationalIdExpiryDate    DateTime?
  selfiePhotoUrl          String?
  role                    Role                @default(PASSENGER)
  isVerified              Boolean             @default(false)
  isActive                Boolean             @default(true)
  otpCode                 String?
  lastLogin               DateTime?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  driverSuspendedUntil    DateTime?
  passengerSuspendedUntil DateTime?
  bookings                Booking[]           @relation("PassengerBookings")
  driverVerification      DriverVerification?
  notification            Notification[]
  createdRoutes           Route[]             @relation("DriverRoutes")
  vehicles                Vehicle[]

  //Relations
  reportedIncidents Incident[] @relation("ReporterIncidents")
  incidentsAgainst  Incident[] @relation("ReportedUserIncidents")
  resolvedIncidents Incident[] @relation("ResolverIncidents")

  @@index([role])
  @@index([isActive])
  @@index([isVerified])
  @@index([createdAt])
}

model DriverVerification {
  id                 String             @id @default(cuid())
  userId             String             @unique
  licenseNumber      String             @unique
  firstNameOnLicense String
  lastNameOnLicense  String
  licenseIssueDate   DateTime
  licenseExpiryDate  DateTime
  licensePhotoUrl    String
  selfiePhotoUrl     String
  typeOnLicense      LicenseType
  status             VerificationStatus @default(PENDING)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([createdAt])
  @@index([licenseIssueDate])
  @@index([licenseExpiryDate])
}

model Notification {
  id              String           @id @default(cuid())
  userId          String
  type            NotificationType @default(SYSTEM)
  title           String
  body            String
  link            String?
  metadata        Json?            @db.Json
  readAt          DateTime?
  createdAt       DateTime         @default(now())
  adminReviewedAt DateTime?
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  incidentsId String?
  incident    Incident? @relation("IncidentNotifications", fields: [incidentsId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@index([adminReviewedAt])
}

model Vehicle {
  id           String   @id @default(cuid())
  userId       String
  vehicleModel String
  licensePlate String   @unique
  vehicleType  String
  color        String
  seatCapacity Int
  amenities    String[]
  photos       Json?    @db.Json
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  routes       Route[]
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([vehicleType])
  @@index([seatCapacity])
}

model Route {
  id              String      @id @default(cuid())
  driverId        String
  vehicleId       String
  startLocation   Json        @db.Json
  endLocation     Json        @db.Json
  departureTime   DateTime
  availableSeats  Int
  pricePerSeat    Float
  conditions      String?
  status          RouteStatus @default(AVAILABLE)
  routeSummary    String?
  distance        String?
  duration        String?
  waypoints       Json?       @db.Json
  landmarks       Json?       @db.Json
  steps           Json?       @db.Json
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  routePolyline   String?
  distanceMeters  Int?
  durationSeconds Int?
  cancelledAt     DateTime?
  cancelledBy     String?
  bookings        Booking[]
  driver          User        @relation("DriverRoutes", fields: [driverId], references: [id], onDelete: Cascade)
  vehicle         Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  incidents       Incident[]

  @@index([driverId])
  @@index([vehicleId])
  @@index([status])
  @@index([createdAt])
  @@index([departureTime])
}

model Booking {
  id              String        @id @default(cuid())
  routeId         String
  passengerId     String
  numberOfSeats   Int
  status          BookingStatus @default(PENDING)
  pickupLocation  Json          @db.Json
  dropoffLocation Json          @db.Json
  createdAt       DateTime      @default(now())
  cancelledAt     DateTime?
  cancelledBy     String?
  cancelReason    CancelReason?
  passenger       User          @relation("PassengerBookings", fields: [passengerId], references: [id], onDelete: Cascade)
  route           Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)
  incidents       Incident[]
}

model Incident {
  id             String           @id @default(cuid())
  reporterId     String
  reportedUserId String?
  routeId        String?
  bookingId      String?
  type           IncidentType
  status         IncidentStatus   @default(PENDING)
  priority       IncidentPriority @default(NORMAL)
  title          String
  description    String           @db.Text
  location       Json?            @db.Json
  evidenceUrls   String[]
  metadata       Json?            @db.Json
  resolvedBy     String?
  resolvedAt     DateTime?
  resolution     String?          @db.Text
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  //Relations
  reporter      User           @relation("ReporterIncidents", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser  User?          @relation("ReportedUserIncidents", fields: [reportedUserId], references: [id], onDelete: SetNull)
  resolver      User?          @relation("ResolverIncidents", fields: [resolvedBy], references: [id], onDelete: SetNull)
  route         Route?         @relation(fields: [routeId], references: [id], onDelete: SetNull)
  booking       Booking?       @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  notifications Notification[] @relation("IncidentNotifications")

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([routeId])
  @@index([bookingId])
  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([createdAt])
  @@index([resolvedAt])
}

enum Role {
  PASSENGER
  DRIVER
  ADMIN
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RouteStatus {
  AVAILABLE
  FULL
  COMPLETED
  CANCELLED
  IN_TRANSIT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED
}

enum CancelReason {
  CHANGE_OF_PLAN
  FOUND_ALTERNATIVE
  DRIVER_DELAY
  PRICE_ISSUE
  WRONG_LOCATION
  DUPLICATE_OR_WRONG_DATE
  SAFETY_CONCERN
  WEATHER_OR_FORCE_MAJEURE
  COMMUNICATION_ISSUE
}

enum LicenseType {
  PRIVATE_CAR_TEMPORARY
  PRIVATE_CAR
  PUBLIC_CAR
  LIFETIME
}

enum NotificationType {
  SYSTEM
  VERIFICATION
  BOOKING
  ROUTE
  INCIDENT
}

enum IncidentType {
  SAFETY_CONCERN
  INAPPROPRIATE_BEHAVIOR
  HARASSMENT
  ACCIDENT
  VEHICLE_ISSUE
  FRAUD
  ROUTE_ISSUE
  PAYMENT_DISPUTE
  OTHER
}

enum IncidentStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  DISMISSED
  ESCALATED
}

enum IncidentPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
