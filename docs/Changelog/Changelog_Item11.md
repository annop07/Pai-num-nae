CHANGELOG

Product Backlog Item No.11: As a driver, I want to report incidents to the admin and get the update on the filed case.

#### การพัฒนาฟังก์ชันแจ้งเหตุสำหรับผู้ขับ

- แจ้งเหตุการณ์ด้านความปลอดภัยจากหน้า My Route ได้โดยตรง
- กรอกข้อมูลรายละเอียดเหตุการณ์ผ่านแบบฟอร์ม
- ได้รับการยืนยันเมื่อส่งรายงานสำเร็จ
- สามารถเริ่มต้นการสนทนากับ Admin หลังจากส่งรายงานเรียบร้อย

#### การปรับปรุงส่วนติดต่อผู้ใช้

หน้า My Route

- เพิ่มปุ่มแจ้งเหตุ ในรายการคำขอจอง

หน้า Incident Form

- Dropdown สำหรับเลือกประเภทปัญหา
- ปุ่มเลือกระดับความเร่งด่วน
- ช่องกรอกหัวข้อ (ไม่เกิน 100 ตัวอักษร)
- ช่องกรอกรายละเอียดเหตุการณ์
- เลือกตำแหน่งผ่าน Google Maps
- อัปโหลดไฟล์รูปภาพ/วิดีโอ (สูงสุด 10MB)
- ปุ่มรายงานเหตุการณ์

Success Modal

- แสดง Pop-up แจ้งว่าส่งข้อมูลเรียบร้อยแล้ว
- มีปุ่มให้เลือก แชทกับ Admin หรือ ปิด Pop-up

#### การปรับปรุงโครงสร้างไฟล์โปรเจค

- ในไฟล์ pages/myRoute/index.vue มีการเพิ่มปุ่มแจ้งเหตุในแต่ละรายการเดินทาง
- เพิ่มฟังก์ชัน goToIncidentForm(trip) เพื่อลิงค์ไปที่หน้า formIncident
- สร้างไฟล์ใหม่ pages/formIncident/index.vue แสดงแบบฟอร์มแจ้งเหตุ ที่รองรับ Google Maps, File Upload แสดง Success Modal และเชื่อมต่อไปยังหน้า Chat

---

#### การพัฒนาระบบแชท (Chat System)

##### ฟีเจอร์หลัก

หน้าแชท (pages/chat/index.vue)

- แสดงรายการห้องแชท (Inbox) ในแนวข้าง พร้อมข้อความล่าสุดและเวลา
- เปิดห้องแชทได้โดยตรงจาก URL query (?room=chatRoomId) เพื่อรองรับการนำทางจากหน้า Incident Form และ Admin Incident Management
- แสดงประวัติข้อความพร้อม timestamp
- รองรับการส่งข้อความ 3 รูปแบบ ได้แก่ ข้อความธรรมดา (TEXT), ไฟล์รูปภาพและวิดีโอ (FILE) และตำแหน่งพิกัด (LOCATION)
- แสดงแผนที่แบบ Embed เมื่อมีการส่งตำแหน่ง พร้อมลิงก์เปิด Google Maps
- เตือนเมื่อขาดการเชื่อมต่อ Socket
- รองรับการแสดงผลบนมือถือและเดสก์ท็อป (Responsive Design)

##### ฟีเจอร์สำหรับ Admin

- ปุ่ม ปิดการสนทนา (Close Chat) แสดงเฉพาะเมื่อเข้าใช้ในบทบาท Admin และห้องแชทยังเปิดอยู่
- เมื่อกดปิด ระบบจะขอยืนยันก่อน จากนั้นเรียก API อัปเดตสถานะห้องแชทเป็น CLOSED
- หลังปิด ช่องพิมพ์ข้อความและปุ่มส่งทั้งหมดจะถูก Disable ทันที พร้อมแสดงข้อความแจ้งเตือน "การสนทนานี้ถูกปิดแล้ว"
- ปุ่มปิดแสดงที่จุดพิมพ์ข้อความ Desktop Header และ Mobile Header

##### ฟีเจอร์สำหรับ Driver และ Passenger

หน้าติดตามเหตุการณ์ (pages/myIncidents/index.vue)

- แสดงรายการเหตุการณ์ทั้งหมดที่ผู้ใช้แจ้งหรือถูกแจ้ง ดึงข้อมูลจาก API /incidents/me
- แสดง Dashboard สรุปจำนวนเหตุการณ์แยกตามสถานะ (ทั้งหมด / รอดำเนินการ / กำลังตรวจสอบ / แก้ไขแล้ว)
- กรองรายการตามสถานะได้ (PENDING, INVESTIGATING, RESOLVED, DISMISSED, ESCALATED)
- คลิกที่รายการเพื่อดูรายละเอียดแบบเต็มในโมดัล รวมถึงรูปหลักฐาน ตำแหน่งที่เกิดเหตุ และหมายเหตุจาก Admin
- ปุ่ม แชทกับ Admin บนแต่ละรายการ นำทางไปยังห้องแชทที่เชื่อมโยงกับเหตุการณ์นั้นโดยตรง

##### การนำทางจาก Incident Form ไปยังแชท

- หลังส่งแบบฟอร์มแจ้งเหตุสำเร็จ ระบบจะรับ chatRoomId จาก API response
- ปุ่ม แชทกับ Admin ใน Success Modal จะนำทางไปยัง /chat?room={chatRoomId} เพื่อเปิดห้องแชทที่ถูกต้องโดยอัตโนมัติ

##### การปรับปรุงโครงสร้างไฟล์โปรเจค

- สร้างไฟล์ใหม่ pages/myIncidents/index.vue สำหรับหน้าติดตามสถานะเหตุการณ์ของ Driver/Passenger
- แก้ไขไฟล์ composables/useChat.js เพิ่มฟังก์ชัน closeChatRoom() สำหรับเรียก API ปิดห้องแชท
- แก้ไขไฟล์ pages/chat/index.vue เพิ่ม logic และ UI สำหรับปุ่มปิดการสนทนาสำหรับ Admin
- แก้ไขไฟล์ pages/admin/incidents/index.vue แก้ไขการแสดงรูปหลักฐานในโมดัล จาก attachments เป็น evidenceUrls ให้ตรงกับ schema จริง
- แก้ไขไฟล์ backend/src/services/incident.service.js ให้ return chatRoom.id พร้อมกับข้อมูล incident เมื่อสร้างสำเร็จ
- แก้ไขไฟล์ layouts/default.vue เพิ่มลิงก์เมนู "ติดตามเหตุการณ์" ทั้ง Desktop และ Mobile สำหรับ Driver/Passenger
